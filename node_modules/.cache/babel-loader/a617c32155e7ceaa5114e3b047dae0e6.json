{"ast":null,"code":"var d3 = window.d3;\n\nvar extend = require('extend');\n\nvar pressed = require('key-pressed');\n\nvar keydown = require('keydown');\n\nvar integrateSimpson = require('integrate-adaptive-simpson');\n\nmodule.exports = function (options) {\n  options = extend({\n    key: '<shift>',\n    // true to make the brush mask visible/hidden on keydown\n    // by default the mask will be visible only when the `key`\n    // combination is pressed\n    toggle: false\n  }, options);\n  var brush = d3.svg.brush();\n  var kd = keydown(options.key);\n  var visible = false;\n  var cachedInstance; // the integrator module requires a function with a single parameter x\n\n  function wrapper(datum) {\n    return function (x) {\n      var functionPlot = window.functionPlot;\n      return functionPlot.eval.builtIn(datum, 'fn', {\n        x: x\n      });\n    };\n  }\n\n  function setBrushState(visible) {\n    var brushEl = cachedInstance.canvas.selectAll('.definite-integral');\n    brushEl.style('display', visible ? null : 'none');\n  }\n\n  function inner(instance) {\n    cachedInstance = instance; // update the brush scale with the instance scale\n\n    var oldDisableZoom;\n    brush.x(instance.meta.xScale).on('brushstart', function () {\n      if (!d3.event.sourceEvent) return;\n      oldDisableZoom = !!instance.options.disableZoom;\n      instance.options.disableZoom = true; // replot the samples with the option disableZoom set to true\n\n      instance.emit('draw');\n    }).on('brushend', function () {\n      if (!d3.event.sourceEvent) return;\n      instance.options.disableZoom = oldDisableZoom;\n\n      if (!brush.empty()) {\n        var a = brush.extent()[0];\n        var b = brush.extent()[1]; // iterate the data finding the value of the definite integral\n        // with bounds `a` and `b`\n\n        instance.options.data.forEach(function (datum, i) {\n          var value = integrateSimpson(wrapper(datum), a, b, options.tol, options.maxdepth);\n          instance.emit('definite-integral', datum, i, value, a, b);\n        });\n      } // replot the samples with the option disableZoom set to whatever it was before\n\n\n      instance.draw();\n    });\n    var brushEl = instance.canvas.append('g').attr('class', 'brush definite-integral');\n    brushEl.call(brush).call(brush.event);\n    instance.canvas.selectAll('.brush .extent').attr('stroke', '#fff').attr('fill-opacity', 0.125).attr('shape-rendering', 'crispEdges');\n    brushEl.selectAll('rect').attr('height', instance.meta.height);\n    instance.canvas.on('mousemove.definiteIntegral', function () {\n      // options.toggle sets the mask visibility when all the required\n      // are pressed once and it's not disabled on keyup\n      if (!options.toggle) {\n        inner.visible(pressed(options.key));\n      }\n    });\n    kd.on('pressed', function () {\n      inner.visible(options.toggle ? !inner.visible() : true);\n    });\n    inner.visible(false);\n  }\n\n  inner.visible = function (_) {\n    if (!arguments.length) {\n      return visible;\n    }\n\n    visible = _;\n    setBrushState(_);\n    return inner;\n  };\n\n  return inner;\n};","map":null,"metadata":{},"sourceType":"script"}